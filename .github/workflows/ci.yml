name: CI - Build, Test, and Publish

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend

jobs:
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'src/frontend/package-lock.json'

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "src/**/uv.lock"

    - name: Install dependencies
      run: |
        # Install backend dependencies
        cd src/backend
        uv sync --group dev

        # Install frontend dependencies
        cd ../frontend
        npm ci

    - name: Run backend quality checks
      working-directory: src/backend
      run: |
        uv run ruff check app/
        uv run ruff format --check app/
        uv run mypy app --ignore-missing-imports
        
    - name: Run frontend quality checks
      working-directory: src/frontend
      run: |
        npm run lint
        npm run type-check
        
    - name: Run Bandit security scan
      working-directory: src/backend
      run: |
        echo "Running Bandit security scan..."
        uv run bandit -r app -f json -o bandit-report.json
        echo "Bandit scan completed successfully - no security issues found!"
        
    - name: Display Bandit results on failure
      if: failure()
      working-directory: src/backend
      run: |
        echo "‚ùå Bandit security scan failed!"
        echo "üìã Security issues found:"
        if [ -f bandit-report.json ]; then
          # Show human-readable output
          echo "=== BANDIT SECURITY ISSUES ==="
          uv run bandit -r app -f screen || true
          echo ""
          echo "=== DETAILED JSON REPORT ==="
          cat bandit-report.json | head -50
          echo "... (see full report in artifacts)"
        else
          echo "No bandit report generated - check bandit installation"
        fi
        echo ""
        echo "üîß To fix these issues:"
        echo "  1. Review the security findings above"
        echo "  2. Fix legitimate security issues in the code"
        echo "  3. Add '# nosec' comments for false positives"
        echo "  4. Update .bandit configuration if needed"
        echo ""
        echo "üìö Documentation: https://bandit.readthedocs.io/en/latest/"
        
    - name: Upload Bandit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-results
        path: src/backend/bandit-report.json

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: quality-checks
    
    services:
      # Add test dependencies if needed (e.g., Redis, PostgreSQL)
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "src/backend/uv.lock"
          
    - name: Install dependencies
      working-directory: src/backend
      run: |
        uv sync --group dev
        
    - name: Run backend tests
      working-directory: src/backend
      run: |
        uv run pytest tests/ --cov=app --cov-report=xml --cov-report=html --junitxml=test-results.xml
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results
        path: src/backend/test-results.xml
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-coverage
        path: src/backend/htmlcov/
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: src/backend/coverage.xml
        flags: backend
        name: backend-coverage

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'src/frontend/package-lock.json'
          
    - name: Install dependencies
      working-directory: src/frontend
      run: |
        npm ci
        
    - name: Run frontend tests
      working-directory: src/frontend
      run: |
        npm run test:coverage
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-test-results
        path: src/frontend/coverage/
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-coverage
        path: src/frontend/coverage/
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: src/frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  build-and-push-images:
    name: Build and Push Container Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set lowercase repository name
      run: |
        echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=run-${{ github.run_id }}
          
    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=run-${{ github.run_id }}
          
    - name: Prepare build context for backend
      run: |
        # Copy required files to backend build context for Docker metadata validation
        cp LICENSE ./src/backend/
        cp README.md ./src/backend/
        
    - name: Prepare build context for frontend  
      run: |
        # Copy required files to frontend build context for Docker metadata validation
        cp LICENSE ./src/frontend/
        cp README.md ./src/frontend/
        
    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./src/backend
        file: ./src/backend/Dockerfile
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./src/frontend
        file: ./src/frontend/Dockerfile
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      packages: read
      security-events: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set lowercase repository name
      run: |
        echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Verify backend image exists
      run: |
        echo "Verifying backend image exists: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/backend:run-${{ github.run_id }}"
        if ! docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/backend:run-${{ github.run_id }}; then
          echo "‚ùå Backend image not found in registry"
          echo "Available tags for backend:"
          docker images | grep "backend" || echo "No backend images found"
          exit 1
        fi
        echo "‚úÖ Backend image verified"
        
    - name: Verify frontend image exists  
      run: |
        echo "Verifying frontend image exists: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/frontend:run-${{ github.run_id }}"
        if ! docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/frontend:run-${{ github.run_id }}; then
          echo "‚ùå Frontend image not found in registry"
          echo "Available tags for frontend:"
          docker images | grep "frontend" || echo "No frontend images found"
          exit 1
        fi
        echo "‚úÖ Frontend image verified"
        
    - name: Run Trivy vulnerability scanner - Backend
      uses: aquasecurity/trivy-action@0.32.0
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/backend:run-${{ github.run_id }}
        format: 'sarif'
        output: 'backend-trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Run Trivy vulnerability scanner - Frontend
      uses: aquasecurity/trivy-action@0.32.0
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/frontend:run-${{ github.run_id }}
        format: 'sarif'
        output: 'frontend-trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Upload Backend Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('backend-trivy-results.sarif') != ''
      with:
        sarif_file: backend-trivy-results.sarif
        category: 'trivy-backend'
        
    - name: Upload Frontend Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('frontend-trivy-results.sarif') != ''
      with:
        sarif_file: frontend-trivy-results.sarif
        category: 'trivy-frontend'
        
    - name: Upload Trivy scan results as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-security-scan-results
        path: |
          backend-trivy-results.sarif
          frontend-trivy-results.sarif
        retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-push-images, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write
    
    outputs:
      release-tag: ${{ steps.create-release.outputs.tag_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set lowercase repository name
      run: |
        echo "REPO_LOWER=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
        
    - name: Get latest tag
      id: get-latest-tag
      run: |
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "latest_tag=${latest_tag}" >> $GITHUB_OUTPUT
        
    - name: Generate release notes
      id: generate-notes
      run: |
        # Simple release notes generation
        echo "## Changes in this release" > release-notes.md
        echo "" >> release-notes.md
        
        # Generate commit list based on whether tags exist
        if [[ -n "${{ steps.get-latest-tag.outputs.latest_tag }}" ]]; then
          # Use tag range if previous tag exists
          git log ${{ steps.get-latest-tag.outputs.latest_tag }}..HEAD --pretty=format:"- %s (%h)" >> release-notes.md
        else
          # Use all commits if no previous tags exist
          git log --pretty=format:"- %s (%h)" >> release-notes.md
        fi
        
        echo "" >> release-notes.md
        echo "## Container Images" >> release-notes.md
        echo "- Backend: \`${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/backend:run-${{ github.run_id }}\`" >> release-notes.md
        echo "- Frontend: \`${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/frontend:run-${{ github.run_id }}\`" >> release-notes.md
        echo "" >> release-notes.md
        echo "**Workflow Run ID**: ${{ github.run_id }}" >> release-notes.md
        
    - name: Create release
      id: create-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

  deploy-dev:
    name: Deploy to Development
    needs: create-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/deploy.yml
    with:
      environment: dev
      image_tag: run-${{ github.run_id }}
      release_tag: v${{ github.run_number }}
      run_id: run-${{ github.run_id }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  deploy-prod:
    name: Deploy to Production
    needs: [create-release, deploy-dev]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/deploy.yml
    with:
      environment: prod
      image_tag: run-${{ github.run_id }}
      release_tag: v${{ github.run_number }}
      run_id: run-${{ github.run_id }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_PROD }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID_PROD }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_PROD }}

  notify-completion:
    name: Notify Build and Deployment Completion
    runs-on: ubuntu-latest
    needs: [create-release, deploy-dev, deploy-prod]
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.create-release.result == 'success' && needs.deploy-dev.result == 'success' && needs.deploy-prod.result == 'success'
      run: |
        echo "‚úÖ Build and deployment completed successfully"
        echo "üöÄ Release created: v${{ github.run_number }}"
        echo "üì¶ Container images published to GHCR"
        echo "üåç Development and production environments deployed"
        
    - name: Notify on partial success
      if: needs.create-release.result == 'success' && needs.deploy-dev.result == 'success' && needs.deploy-prod.result != 'success'
      run: |
        echo "‚ö†Ô∏è Build and development deployment completed successfully"
        echo "üöÄ Release created: v${{ github.run_number }}"
        echo "üì¶ Container images published to GHCR"
        echo "üåç Development environment deployed"
        echo "‚ùå Production deployment failed or was skipped"
        
    - name: Notify on failure
      if: needs.create-release.result == 'failure' || needs.deploy-dev.result == 'failure' || needs.deploy-prod.result == 'failure'
      run: |
        echo "‚ùå Build or deployment failed"
        echo "üìã Check the workflow logs for details"
        if [ "${{ needs.create-release.result }}" == "failure" ]; then
          echo "üí• Release creation failed"
        fi
        if [ "${{ needs.deploy-dev.result }}" == "failure" ]; then
          echo "üí• Development deployment failed"
        fi
        if [ "${{ needs.deploy-prod.result }}" == "failure" ]; then
          echo "üí• Production deployment failed"
        fi
        exit 1